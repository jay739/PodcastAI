<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .file-drop-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
        }
        .file-drop-area.active {
            border-color: #4299e1;
            background-color: rgba(66, 153, 225, 0.1);
        }
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background-color: #ebf5ff;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #4299e1;
            transition: width 0.3s ease;
        }
        .voice-card {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .voice-card.selected {
            border-color: #4299e1;
            background-color: #ebf5ff;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Podcast Generator</h1>
            <p class="text-gray-600">Upload a PDF to generate a podcast with distinctive character voices</p>
        </header>

        <main>
            <!-- Step 1: Upload PDF -->
            <section id="upload-section" class="mb-12">
                <h2 class="text-xl font-semibold mb-4">Step 1: Upload PDF Document</h2>
                <div class="file-drop-area" id="drop-area">
                    <p class="mb-4 text-gray-600">Drag & drop your PDF here, or</p>
                    <input type="file" id="file-input" accept=".pdf" class="hidden">
                    <button id="select-file-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                        Select File
                    </button>
                    <p class="mt-2 text-sm text-gray-500" id="file-info">No file selected</p>
                </div>
            </section>

            <!-- Step 2: Analysis Results -->
            <section id="analysis-section" class="mb-12 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 2: Document Analysis</h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-gray-800">Pages</h3>
                            <p class="text-2xl font-bold text-blue-600" id="page-count">-</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-gray-800">Words</h3>
                            <p class="text-2xl font-bold text-blue-600" id="word-count">-</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-medium text-gray-800">Characters</h3>
                            <p class="text-2xl font-bold text-blue-600" id="speaker-count">-</p>
                        </div>
                    </div>

                    <h3 class="font-medium text-gray-800 mb-2">Detected Characters:</h3>
                    <div id="speakers-list" class="mb-6">
                        <p class="text-gray-600">Analyzing document...</p>
                    </div>
                    <div class="flex space-x-4 mt-6">
                        <button onclick="showUploadSection()" class="border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded transition-colors hover:bg-gray-100">
                            Back to Upload
                        </button>
                        <button id="customize-voices-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            Customize Voices
                        </button>
                    </div>
                </div>
            </section>

            <!-- Step 3: Voice Customization -->
            <section id="voice-section" class="mb-12 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 3: Customize Character Voices</h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <div id="voice-customization" class="mb-6">
                        <!-- Voice cards will be added here dynamically -->
                    </div>

                    <div class="flex items-center mb-6">
                        <input type="checkbox" id="background-music" class="mr-2">
                        <label for="background-music" class="text-gray-700">Add background music</label>
                    </div>

                    <div class="flex space-x-4">
                        <button id="back-to-analysis-btn" class="border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded transition-colors hover:bg-gray-100">
                            Back
                        </button>
                        <button id="generate-podcast-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            Generate Podcast
                        </button>
                    </div>
                </div>
            </section>

            <!-- Step 4: Generation Progress -->
            <section id="progress-section" class="mb-12 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 4: Generating Podcast</h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <p class="mb-3 text-gray-700" id="status-message">Processing...</p>
                    <div class="progress-bar mb-6">
                        <div class="progress-bar-fill" id="progress-bar" style="width: 0%"></div>
                    </div>
                    <p class="text-sm text-gray-600" id="progress-details">Starting generation...</p>
                </div>
            </section>

            <!-- Step 5: Result -->
            <section id="result-section" class="mb-12 hidden">
                <h2 class="text-xl font-semibold mb-4">Step 5: Your Podcast</h2>
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="font-medium text-gray-800 mb-4">Podcast Generation Complete!</h3>
                
                    <div class="mb-6">
                        <audio id="audio-player" controls class="w-full">
                            Your browser does not support the audio element.
                        </audio>
                    </div>
                
                    <div class="flex space-x-4">
                        <button id="download-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded transition-colors">
                            Download Podcast
                        </button>
                        <button id="start-over-btn" class="border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded transition-colors hover:bg-gray-100">
                            Start Over
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Global variables
        let fileId = null;
        let jobId = null;
        let speakers = [];
        
        // DOM elements (keep your existing element references)
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        const selectFileBtn = document.getElementById('select-file-btn');
        const fileInfo = document.getElementById('file-info');
        const uploadSection = document.getElementById('upload-section');
        const analysisSection = document.getElementById('analysis-section');
        const voiceSection = document.getElementById('voice-section');
        const progressSection = document.getElementById('progress-section');
        const resultSection = document.getElementById('result-section');
    
        const pageCount = document.getElementById('page-count');
        const wordCount = document.getElementById('word-count');
        const speakerCount = document.getElementById('speaker-count');
        const speakersList = document.getElementById('speakers-list');
    
        const customizeVoicesBtn = document.getElementById('customize-voices-btn');
        const voiceCustomization = document.getElementById('voice-customization');
        const backToAnalysisBtn = document.getElementById('back-to-analysis-btn');
        const generatePodcastBtn = document.getElementById('generate-podcast-btn');
        const backgroundMusic = document.getElementById('background-music');
    
        const statusMessage = document.getElementById('status-message');
        const progressBar = document.getElementById('progress-bar');
        const progressDetails = document.getElementById('progress-details');
    
        const audioPlayer = document.getElementById('audio-player');
        const downloadBtn = document.getElementById('download-btn');
        const startOverBtn = document.getElementById('start-over-btn');
    

        // Event Listeners
        selectFileBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        
        // Drag and drop (keep your existing implementation)
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() { dropArea.classList.add('active'); }
        function unhighlight() { dropArea.classList.remove('active'); }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            handleFiles(dt.files);
        }

        // Button event listeners
        customizeVoicesBtn.addEventListener('click', showVoiceCustomization);
        backToAnalysisBtn.addEventListener('click', showAnalysisSection);
        generatePodcastBtn.addEventListener('click', generatePodcast);
        downloadBtn.addEventListener('click', downloadPodcast);
        startOverBtn.addEventListener('click', startOver);

        // File handling
        async function handleFileSelect(e) {
            handleFiles(this.files);
        }

        async function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'application/pdf') {
                    fileInfo.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
                    const filePath = await window.podcastAPI.files.select();
                    if (filePath) {
                    await uploadFile(filePath);
                    }
                } else {
                    alert('Please select a PDF file.');
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' bytes';
            else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            else return (bytes / 1048576).toFixed(1) + ' MB';
        }

        // API Operations
        async function uploadFile(filePath) {
            try {
            showProgressSection();
            statusMessage.textContent = 'Uploading file...';
            progressBar.style.width = '20%';
    
            // Upload the file
            const result = await window.podcastAPI.files.upload(filePath);
            fileId = result.fileId;
    
            // Update progress and analyze
            progressBar.style.width = '50%';
            statusMessage.textContent = 'Processing document...';
            await analyzeDocument();
    
            } catch (error) {
                console.error('Upload failed:', error);
                showUploadSection();
                alert(`Error: ${error.message}`);
            }
        }

        async function analyzeDocument() {
            try {
                progressBar.style.width = '70%';
                statusMessage.textContent = 'Analyzing document...';
    
                const analysis = await window.podcastAPI.files.analyze(fileId);
    
                // Complete progress and show results
                progressBar.style.width = '100%';
                statusMessage.textContent = 'Analysis complete!';
    
                // Small delay for UX before showing results
                setTimeout(() => {
                displayAnalysisResults(analysis);
                }, 500);
    
                } catch (error) {
                    showUploadSection();
                    alert('Analysis failed: ' + error.message);
                }
            }

        async function generatePodcast() {
            try {
                showProgressSection();
                statusMessage.textContent = 'Generating podcast...';
                progressBar.style.width = '0%';
                progressDetails.textContent = 'Starting generation process...';
                
                // Set up progress listener
                window.podcastAPI.on.progress((progress) => {
                    progressBar.style.width = `${progress}%`;
                    progressDetails.textContent = `${Math.round(progress)}% complete`;
                });

                // Collect voice settings
                const voiceSettings = {};
                speakers.forEach(speaker => {
                    const speakerId = speaker.name.replace(/\s+/g, '-');
                    voiceSettings[speaker.name] = {
                        voice_type: document.querySelector(`#voice-type-${speakerId}`).value,
                        modulation_level: document.querySelector(`#modulation-${speakerId}`).value
                    };
                });
                
                const config = {
                    fileId: fileId,
                    voice_settings: voiceSettings,
                    background_music: document.getElementById('background-music').checked
                };
                
                const result = await window.podcastAPI.podcast.generate(config);
                jobId = result.jobId;
                await monitorJobStatus();
            } catch (error) {
                showVoiceSection();
                alert('Error starting generation: ' + error.message);
            }
        }

        async function monitorJobStatus() {
            try {
                console.log('Checking job status for', jobId);
                const status = await window.podcastAPI.jobs.getStatus(jobId);
                console.log('Job status response:', status);
                if (status.status === 'completed') {
                    showResultSection(status.resultUrl);
                } else if (status.status === 'failed') {
                    throw new Error(status.message || 'Generation failed');
                } else {
                    setTimeout(monitorJobStatus, 2000);
                }
            } catch (error) {
                showVoiceSection();
                alert('Error during generation: ' + error.message);
            }
        }

        async function downloadPodcast() {
            try {
                const filePath = await window.podcastAPI.podcast.download(jobId);
                alert(`Podcast saved to: ${filePath}`);
            } catch (error) {
                alert('Error downloading podcast: ' + error.message);
            }
        }

        // UI Functions (keep your existing implementations)
        function displayAnalysisResults(analysis) {
    // Display basic metrics
    pageCount.textContent = analysis.page_count || 0;
    wordCount.textContent = analysis.word_count || 0;
    speakerCount.textContent = analysis.char_count || 0;

    // Handle speakers display
    speakers = analysis.speakers || [];
    speakersList.innerHTML = speakers.length > 0 
        ? speakers.map(speaker =>`<div class="py-2 px-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                    <span class="font-medium dark:text-gray-200">${speaker.name || 'Unknown'}</span>
                    <span class="text-gray-500 dark:text-gray-400 text-sm ml-2">
                        (${speaker.frequency || 0} mentions)
                    </span>
                </div>`).join('')
        : '<div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">' +
          '<p class="text-yellow-700 dark:text-yellow-300">' +
          'No speakers detected - will use default Host/Expert format</p></div>';

    // Show detailed debug info if available
    if (analysis.debug) {
        const debugInfo = document.createElement('div');
        debugInfo.className = 'mt-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg';
        debugInfo.innerHTML = `
            <h4 class="font-bold mb-2 dark:text-white">Debug Information:</h4>
            <p class="text-sm"><strong>File:</strong> ${analysis.debug.file_path}</p>
            <p class="text-sm"><strong>Size:</strong> ${analysis.debug.file_size} bytes</p>
            <div class="mt-2">
                ${analysis.debug.extraction_attempts.map(([lib, result]) => `
                <div class="mb-2">
                    <p class="font-medium dark:text-gray-300">${lib}:</p>
                    <pre class="text-xs p-2 bg-white dark:bg-gray-700 rounded overflow-auto">${
                        result.length > 100 ? result.substring(0, 100) + '...' : result
                    }</pre>
                </div>
                `).join('')}
            </div>
        `;
        speakersList.after(debugInfo);
    }

    showAnalysisSection();
}
        function showVoiceCustomization() {
            voiceCustomization.innerHTML = speakers.map(speaker => {
                const speakerId = speaker.name.replace(/\s+/g, '-');
                return `
                <div class="voice-card" id="voice-card-${speakerId}">
                    <h3 class="font-medium text-gray-800 mb-2">${speaker.name}</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Voice Type</label>
                        <select id="voice-type-${speakerId}" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="neutral">Neutral</option>
                            <option value="deep">Deep</option>
                            <option value="high">High</option>
                            <option value="child" ${speaker.name.toLowerCase().includes('child') ? 'selected' : ''}>Child</option>
                            <option value="elder" ${speaker.name.toLowerCase().includes('elder') ? 'selected' : ''}>Elderly</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Emotion Modulation</label>
                        <select id="modulation-${speakerId}" class="w-full border border-gray-300 rounded px-3 py-2">
                            <option value="low">Subtle</option>
                            <option value="medium" selected>Moderate</option>
                            <option value="high">Dramatic</option>
                        </select>
                    </div>
                </div>`;
            }).join('');
            
            showVoiceSection();
        }

        function showResultSection(audioUrl) {
            audioPlayer.src = audioUrl;
            hideAllSections();
            resultSection.classList.remove('hidden');
        }

        function startOver() {
            fileId = null;
            jobId = null;
            speakers = [];
            fileInfo.textContent = 'No file selected';
            audioPlayer.src = '';
            showUploadSection();
        }

        // Section visibility (keep your existing implementations)
        function hideAllSections() {
            document.querySelectorAll('main > section').forEach(section => {
                section.classList.add('hidden');
            });
        }

        function showUploadSection() {
            hideAllSections();
            uploadSection.classList.remove('hidden');
        }

        function showAnalysisSection() {
            hideAllSections();
            analysisSection.classList.remove('hidden');
            analysisSection.style.display = 'block'; // Force show
        }

        function showVoiceSection() {
            hideAllSections();
            voiceSection.classList.remove('hidden');
        }

        function showProgressSection() {
            hideAllSections();
            progressSection.classList.remove('hidden');
        }
    </script>
</body>
</html>